# 分布式随想

## 背景

在理解什么是分布式之前，我们先理解传统系统架构的面临什么问题  
传统的系统架构，数据没有冗余，这样就产生一个可用性低问题，如果发生故障由于数据丢失等种种原因，  
有的系统不可恢复服务，有的系统需要很久才能恢复。这样针对有些对可用要求极高的业务，传统系统架   
构已经不能满足了，所有为了提升系统的可用性，我们提出了分布式的架构。

## 分布式的使命

分布式系统首要的任务就是解决传统系统不可用或者低可用的缺点. 要解决这个问题，那我们就要解决什   
么导致系统不可用的因素。往往我们发现系统之所以不可用，是因为系统是有状态的，状态的丢失，导致  
系统的处理混乱。状态大部分都是系统的持久化数据。这些数据的损坏或者故障，就是导致系统不可用  
的元凶。

## 解决之道

既然找到数据丢失导致系统不可用的元凶，那么最好的解决方案就是对数据进行备份，用术语来讲，就是  
要对系统的数据进行分区. 数据分区如果备份点在本地还是有很大几率本地整个设备都挂了，导致可用性达  
不到需求，所以一般都会选择网络数据分区

## 什么是分布式
我们再来理解分布式，就很简单了，分布式是一个系统，什么样的系统呢？实现了数据分区，让系统具有可  
用性的特点。

## 分布式的缺点
由于数据分区，分布式天然就带来了一些缺点，数据的完全一致性就被打破了传统系统我们都不需要考虑数  
据的一致性，因为数据只有一份，没有所谓的需要处理数据不一致的问题。对外来讲，数据永远是一致的。  
所以这里就有了一个矛盾的问题。数据分区解决了可用性问题，却产生了一致性的问题。  
如果我们想提高系统的可用性，那么我们就必须降低系统的一致性。  
如果我们想提高系统的一致性，那么我们就必须降低系统的可用性。  

## 分布式CAP理论由来
所以这里就产生了著名的CAP理论，我们现在看这三个因素是完全相互作用的。  
但是数据分区这个因素是固定下来的，因为如果把数据分区去掉，都没有然后了。  
所以行业里面分布式设计方案都会在A和P之间做出均衡。

## 分布式设计基础

所以分布式系统的设计都是围绕上面的CAP三个点来的

1. 服务使用的数据块X的在设备A创建
2. 选择另一台设备B创建备份数据块
3. 同步数据块从A到B
4. 发现A的位置有故障，将服务切换到B， 重新选择备份数据块位置C
5. 同步数据块从B到C

***解决数据分区的问题*** 

* 针对数据分区，我们需要定义数据怎么分区

	1. 数据分区初始化
		* 数据分区的创建
		* 数据分区的销毁
		* 数据分区的初始位置选定
			* 分区的主备位置

***解决数据一致性的问题*** 

* 针对一致性，我们需要有数据同步机制，保持数据一致性

	1. 数据同步机制
		* 边界
			* 同步事件
		* 输入
			* 数据块
		* 输出
			* 数据块

***解决数据可用性的问题***

* 针对可用性，(如果数据发生故障)我们需要决定选择哪一个数据分区的机制

	1. 数据故障检测问题
		* 什么是故障
		* 故障处理方式
			* 故障输入
				* 故障检测方式
					* 主动检测
						* 心跳检测
						* 定期磁盘检测
						* 内存检测
						* cpu过载检测
					* 被动检测
						* 收到警告
			* 故障输出
				* 故障通知给谁

	2. 分区位置性能监视	
		* 监视输入
		* 监视输出
			* CPU负载
			* 内存占用率
			* 磁盘使用率
		
	2. 分区角色选择
	
	3. 分区调度模块
		* 调度输入
			* 故障输入
				* 旧的数据分区位置
				* 故障类型
			* 用户指定
				* 旧的数据分区位置
				* 新的数据分区位置
			* UI下发
				* 无旧分区位置
				* 无新分区位置
		* 调度策略
			* Todo
		* 调度输出
			* 新的位置下发数据分区
		


## 其他
#### 如果我们需要系统的高可用呢？
如果数据需要达到完全一致性后才能提供服务，这样往往就不能满足高可用性。因为数据达到完全一  
致性需要时间比较长，所以为了让系统高可用，我们会牺牲掉系统的强一致性。如果系统能在一定时  
间内恢复正常，我们就说这个系统高可用的(高可用这个概念其实也是相对的)，超过了规定的时候限  
制我们就认为不是高可用的


**高可用**

可用性又分为高可用(数据故障后一定延迟后可用)



